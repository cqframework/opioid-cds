{
  "resourceType": "Library",
  "id": "OpioidCDSREC10PatientView",
  "text": {
    "status": "generated",
    "div": "<div xmlns=\"http://www.w3.org/1999/xhtml\"><table class=\"grid dict\"><tr><th scope=\"row\"><b>Id: </b></th><td style=\"padding-left: 25px; padding-right: 25px;\">library-OpioidCDSREC10PatientView</td></tr><tr><th scope=\"row\"><b>Type: </b></th><td style=\"padding-right: 25px;\"> Logic Library </td></tr><tr><th scope=\"row\"><b>Status: </b></th><td style=\"padding-left: 25px; padding-right: 25px;\">active</td></tr><tr style=\"vertical-align: top;\"><th rowspan=\"3\" scope=\"row\"><b>Related: </b></th><td style=\"padding-left: 25px; padding-right: 25px;\"><p style=\"margin-bottom: 5px;\"><b>type: </b><span>depends-on</span></p><p style=\"margin-bottom: 5px;\"><b>Resource: </b><br/><span><span style=\"padding-left: 25px;\"><b>reference: </b><span>http://fhir.org/guides/cdc/opioid-cds/Library/FHIRHelpers</span></span></span></p></td></tr><tr style=\"vertical-align: top;\"><td style=\"padding-left: 25px; padding-right: 25px;\"><p style=\"margin-bottom: 5px;\"><b>type: </b><span>depends-on</span></p><p style=\"margin-bottom: 5px;\"><b>Resource: </b><br/><span><span style=\"padding-left: 25px;\"><b>reference: </b><span>http://fhir.org/guides/cdc/opioid-cds/Library/library-OpioidCDSCommon</span></span></span></p></td></tr><tr style=\"vertical-align: top;\"><td style=\"padding-left: 25px; padding-right: 25px;\"><p style=\"margin-bottom: 5px;\"><b>type: </b><span>depends-on</span></p><p style=\"margin-bottom: 5px;\"><b>Resource: </b><br/><span><span style=\"padding-left: 25px;\"><b>reference: </b><span>http://fhir.org/guides/cdc/opioid-cds/Library/library-OpioidCDSRoutines</span></span></span></p></td></tr><tr style=\"vertical-align: top;\"><th rowspan=\"2\" scope=\"row\"><b>Data Requirements: </b></th><td style=\"padding-left: 25px; padding-right: 25px;\"><div><p style=\"margin-bottom: 5px;\"><b>type: </b><span>Observation</span></p><p style=\"margin-bottom: 5px;\"><b>code filter:</b><br/><span style=\"padding-left: 25px;\"><b>path: </b><span>code</span></span><br/><span style=\"padding-left: 25px;\"><b>valueset: </b><span>org.hl7.fhir.dstu3.model.Reference@c8943360</span></span></p></div></td></tr><tr style=\"vertical-align: top;\"><td style=\"padding-left: 25px; padding-right: 25px;\"><div><p style=\"margin-bottom: 5px;\"><b>type: </b><span>Observation</span></p><p style=\"margin-bottom: 5px;\"><b>code filter:</b><br/><span style=\"padding-left: 25px;\"><b>path: </b><span>code</span></span><br/><span style=\"padding-left: 25px;\"><b>valueset: </b><span>org.hl7.fhir.dstu3.model.Reference@d64bad99</span></span></p></div></td></tr><tr style=\"vertical-align: top;\"><th scope=\"row\"><b>Content: </b></th><td style=\"padding-left: 25px; padding-right: 25px;\"><b>type: </b><span>text/cql</span></td></tr><tr><td colspan=\"2\" style=\"padding-left: 25px; padding-right: 25px;\"><pre><code class=\"language-cql\">library OpioidCDSREC10PatientView version '1.2.3'\n\nusing FHIR version '3.0.0'\n\ninclude FHIRHelpers version '3.0.0' called FHIRHelpers\ninclude OpioidCDSCommon version '1.2.3' called Common\ninclude OpioidCDSRoutines version '1.2.3' called Routines\n\ncode &quot;Urine Drug Screening&quot;: '310627008' from Common.SNOMED display 'Urine drug screening (procedure)'\n\n/*\n**  Recommendation #10\n**    When prescribing opioids for chronic pain, providers should use urine drug\n**    testing before starting opioid therapy and consider urine drug testing at\n**    least annually to assess for prescribed medications as well as other controlled\n**    prescription drugs and illicit drugs (recommendation category: B, evidence type: 4)\n**\n**  When\n**    Provider is prescribing an opioid analgesic with ambulatory misuse potential in the outpatient setting\n**    Prescription is for treating chronic pain.\n**    Opioid review is useful for this patient:\n**      Patient is 18 or over\n**      Patient does not have findings indicating limited life expectancy\n**      Patient does not have orders for therapies indicating end of life care\n**      Patient is not undergoing active cancer treatment:\n**        Patient has had at least 2 encounters within the past year with any diagnosis of cancer\n**    Urine drug screening has not been performed in last 12 months\n**  Then\n**    Recommend urine drug screening\n**      Will perform urine screening\n**      Not for chronic pain management, snooze 3 months\n**      N/A - see comment, snooze 3 months\n**\n*/\n\n// META: Plan Definition: http://fhir.org/guides/cdc/opioid-cds/PlanDefinition/opioid-cds-10-patient-view\n\ncontext Patient\n\ndefine &quot;Lookback Year&quot;:\n  Interval[Today() - 12 months - 1 days, Today() - 1 day]\n\ndefine &quot;Patient Is Being Prescribed Opioid Analgesic with Ambulatory Misuse Potential&quot;:\n  exists (\n    Common.&quot;Active Ambulatory Opioid Rx&quot; AmbulatoryOpioidPrescription\n      where Routines.&quot;Is Chronic Pain Prescription?&quot;(AmbulatoryOpioidPrescription)\n  )\n\ndefine &quot;Is Recommendation Applicable?&quot;:\n  &quot;Inclusion Criteria&quot;\n    and not &quot;Exclusion Criteria&quot;\n\ndefine &quot;Inclusion Criteria&quot;:\n  &quot;Patient Is Being Prescribed Opioid Analgesic with Ambulatory Misuse Potential&quot;\n    and Routines.&quot;Is Opioid Review Useful?&quot;\n    and not &quot;Patient had Urine Screening in Last 12 Months&quot;\n\ndefine &quot;Exclusion Criteria&quot;:\n  false \n\ndefine &quot;Patient had Urine Screening in Last 12 Months&quot;:\n  exists( &quot;Urine Screenings during the Last 12 Months&quot; )\n\ndefine &quot;Urine Screenings during the Last 12 Months&quot;:\n  (\n    [Observation: &quot;code&quot; in Common.&quot;Non-opioid illicit drug urine screening&quot;] IllicitDrugScreen\n      where date from IllicitDrugScreen.effective in day of &quot;Lookback Year&quot;\n        and not (IllicitDrugScreen.status.value in { 'unknown', 'entered-in-error', 'cancelled' })\n  )\n  union\n  (\n    [Observation: &quot;code&quot; in Common.&quot;Opioid drug urine screening&quot;] OpioidDrugScreen\n      where date from OpioidDrugScreen.effective in day of &quot;Lookback Year&quot;\n        and not (OpioidDrugScreen.status.value in { 'unknown', 'entered-in-error', 'cancelled' })\n  )\n\ndefine &quot;No Screening In Last 12 Months Indicator&quot;:\n  if &quot;Is Recommendation Applicable?&quot;\n    then 'warning'\n  else null\n\ndefine &quot;No Screening In Last 12 Months Summary&quot;:\n  if &quot;Is Recommendation Applicable?&quot;\n    then 'Annual Urine Screening Check'\n  else null\n\ndefine &quot;No Screening In Last 12 Months Detail&quot;:\n  if &quot;Is Recommendation Applicable?&quot;\n    then 'Patients on opioid therapy should have a urine drug test performed every 12 months.'\n  else null\n\n// Service Request - Urine Screening\ndefine &quot;Urine Drug Screening Request&quot;:\n  ProcedureRequest {\n    //identifier:,\n    definition: { FHIR.Reference { reference: FHIR.string { value: 'http://fhir.org/guides/cdc/activitydefinition/urine-screening-request' } } },\n    status: FHIR.RequestStatus { value: 'draft' },\n    intent: FHIR.RequestIntent { value: 'proposal' },\n    priority: FHIR.RequestPriority { value: 'routine' },\n    code: FHIR.CodeableConcept { coding: { ToCoding(&quot;Urine Drug Screening&quot;) } },\n    subject: FHIR.Reference { reference: FHIR.string { value: 'Patient/' + Patient.id } },\n    occurrence: FHIR.Period { start: FHIR.dateTime { value: Today() }, end: FHIR.dateTime { value: Today() + 7 days } },\n    authoredOn: FHIR.dateTime { value: Now() },\n    reasonCode: { FHIR.CodeableConcept { text: FHIR.string { value: &quot;No Screening In Last 12 Months Detail&quot; } } }\n    // doesn't really work, need a relatedArtifact here...\n    //reasonCode: { FHIR.CodeableConcept { text: FHIR.string { value: 'https://www.cdc.gov/mmwr/volumes/65/rr/rr6501e1.htm#10_When_prescribing_opioids' } } }\n  }\n\ndefine function ToCoding(code System.Code):\n  FHIR.Coding {\n    code: FHIR.code { value: code.code },\n    system: FHIR.uri { value: code.system },\n    version: FHIR.string { value: code.version },\n    display: FHIR.string { value: code.display }\n  }\n</code></pre>\n                    \n                    \n                </td>\n            </tr>\n        \n    </table>\n</div>"
  },
  "extension": [ {
    "url": "http://hl7.org/fhir/us/cqfmeasures/StructureDefinition/cqfm-softwaresystem",
    "valueReference": {
      "reference": "cqf-tooling"
    }
  } ],
  "url": "http://fhir.org/guides/cdc/opioid-cds/Library/OpioidCDSREC10PatientView",
  "version": "1.2.3",
  "name": "OpioidCDSREC10PatientView",
  "title": "Library - Opioid CDS Logic for recommendation #10 (patient-view)",
  "status": "active",
  "experimental": true,
  "type": {
    "coding": [ {
      "system": "http://terminology.hl7.org/CodeSystem/library-type",
      "code": "logic-library"
    } ]
  },
  "publisher": "Centers for Disease Control and Prevention (CDC)",
  "description": "Opioid decision support logic to evaluate whether the patient has had a urine screening in the past 12 months and provide analysis.",
  "purpose": "The purpose of this library is to determine whether the patient has had a urine screening in the past 12 months. Is so, then check the results for missing opioids that are prescribed, present opioids that aren't prescribed or present illicit drugs.",
  "usage": "This library is used to notify the prescriber/user whether the patient has had a urine screening in the past 12 months and to provide analysis if true.",
  "useContext": [ {
    "code": {
      "system": "http://hl7.org/fhir/usage-context-type",
      "code": "focus",
      "display": "Clinical Focus"
    },
    "valueCodeableConcept": {
      "coding": [ {
        "system": "http://snomed.info/sct",
        "code": "182888003",
        "display": "Medication requested (situation)"
      } ]
    }
  }, {
    "code": {
      "system": "http://hl7.org/fhir/usage-context-type",
      "code": "focus",
      "display": "Clinical Focus"
    },
    "valueCodeableConcept": {
      "coding": [ {
        "system": "http://snomed.info/sct",
        "code": "82423001",
        "display": "Chronic pain (finding)"
      } ]
    }
  } ],
  "jurisdiction": [ {
    "coding": [ {
      "system": "urn:iso:std:iso:3166",
      "code": "US",
      "display": "United States of America"
    } ]
  } ],
  "copyright": "© CDC 2016+.",
  "relatedArtifact": [ {
    "type": "documentation",
    "display": "CDC guideline for prescribing opioids for chronic pain",
    "url": "https://www.cdc.gov/mmwr/volumes/65/rr/rr6501e1.htm?CDC_AA_refVal=https%3A%2F%2Fwww.cdc.gov%2Fmmwr%2Fvolumes%2F65%2Frr%2Frr6501e1er.htm"
  } ],
  "content": [ {
    "contentType": "text/cql",
    "data": "bGlicmFyeSBPcGlvaWRDRFNSRUMxMFBhdGllbnRWaWV3IHZlcnNpb24gJzEuMi4zJwoKdXNpbmcgRkhJUiB2ZXJzaW9uICczLjAuMCcKCmluY2x1ZGUgRkhJUkhlbHBlcnMgdmVyc2lvbiAnMy4wLjAnIGNhbGxlZCBGSElSSGVscGVycwppbmNsdWRlIE9waW9pZENEU0NvbW1vbiB2ZXJzaW9uICcxLjIuMycgY2FsbGVkIENvbW1vbgppbmNsdWRlIE9waW9pZENEU1JvdXRpbmVzIHZlcnNpb24gJzEuMi4zJyBjYWxsZWQgUm91dGluZXMKaW5jbHVkZSBPcGlvaWRDRFNDb21tb25Db25maWcgdmVyc2lvbiAnMS4yLjMnIGNhbGxlZCBDb25maWcKCmNvZGUgIlVyaW5lIERydWcgU2NyZWVuaW5nIjogJzMxMDYyNzAwOCcgZnJvbSBDb21tb24uU05PTUVEIGRpc3BsYXkgJ1VyaW5lIGRydWcgc2NyZWVuaW5nIChwcm9jZWR1cmUpJwoKLyoKKiogIFJlY29tbWVuZGF0aW9uICMxMAoqKiAgICBXaGVuIHByZXNjcmliaW5nIG9waW9pZHMgZm9yIGNocm9uaWMgcGFpbiwgcHJvdmlkZXJzIHNob3VsZCB1c2UgdXJpbmUgZHJ1ZwoqKiAgICB0ZXN0aW5nIGJlZm9yZSBzdGFydGluZyBvcGlvaWQgdGhlcmFweSBhbmQgY29uc2lkZXIgdXJpbmUgZHJ1ZyB0ZXN0aW5nIGF0CioqICAgIGxlYXN0IGFubnVhbGx5IHRvIGFzc2VzcyBmb3IgcHJlc2NyaWJlZCBtZWRpY2F0aW9ucyBhcyB3ZWxsIGFzIG90aGVyIGNvbnRyb2xsZWQKKiogICAgcHJlc2NyaXB0aW9uIGRydWdzIGFuZCBpbGxpY2l0IGRydWdzIChyZWNvbW1lbmRhdGlvbiBjYXRlZ29yeTogQiwgZXZpZGVuY2UgdHlwZTogNCkKKioKKiogIFdoZW4KKiogICAgUHJvdmlkZXIgaXMgcHJlc2NyaWJpbmcgYW4gb3Bpb2lkIGFuYWxnZXNpYyB3aXRoIGFtYnVsYXRvcnkgbWlzdXNlIHBvdGVudGlhbCBpbiB0aGUgb3V0cGF0aWVudCBzZXR0aW5nCioqICAgIFByZXNjcmlwdGlvbiBpcyBmb3IgdHJlYXRpbmcgY2hyb25pYyBwYWluLgoqKiAgICBPcGlvaWQgcmV2aWV3IGlzIHVzZWZ1bCBmb3IgdGhpcyBwYXRpZW50OgoqKiAgICAgIFBhdGllbnQgaXMgMTggb3Igb3ZlcgoqKiAgICAgIFBhdGllbnQgZG9lcyBub3QgaGF2ZSBmaW5kaW5ncyBpbmRpY2F0aW5nIGxpbWl0ZWQgbGlmZSBleHBlY3RhbmN5CioqICAgICAgUGF0aWVudCBkb2VzIG5vdCBoYXZlIG9yZGVycyBmb3IgdGhlcmFwaWVzIGluZGljYXRpbmcgZW5kIG9mIGxpZmUgY2FyZQoqKiAgICAgIFBhdGllbnQgaXMgbm90IHVuZGVyZ29pbmcgYWN0aXZlIGNhbmNlciB0cmVhdG1lbnQ6CioqICAgICAgICBQYXRpZW50IGhhcyBoYWQgYXQgbGVhc3QgMiBlbmNvdW50ZXJzIHdpdGhpbiB0aGUgcGFzdCB5ZWFyIHdpdGggYW55IGRpYWdub3NpcyBvZiBjYW5jZXIKKiogICAgVXJpbmUgZHJ1ZyBzY3JlZW5pbmcgaGFzIG5vdCBiZWVuIHBlcmZvcm1lZCBpbiBsYXN0IDEyIG1vbnRocwoqKiAgVGhlbgoqKiAgICBSZWNvbW1lbmQgdXJpbmUgZHJ1ZyBzY3JlZW5pbmcKKiogICAgICBXaWxsIHBlcmZvcm0gdXJpbmUgc2NyZWVuaW5nCioqICAgICAgTm90IGZvciBjaHJvbmljIHBhaW4gbWFuYWdlbWVudCwgc25vb3plIDMgbW9udGhzCioqICAgICAgTi9BIC0gc2VlIGNvbW1lbnQsIHNub296ZSAzIG1vbnRocwoqKgoqLwoKLy8gTUVUQTogUGxhbiBEZWZpbml0aW9uOiBodHRwOi8vZmhpci5vcmcvZ3VpZGVzL2NkYy9vcGlvaWQtY2RzL1BsYW5EZWZpbml0aW9uL29waW9pZC1jZHMtMTAtcGF0aWVudC12aWV3Cgpjb250ZXh0IFBhdGllbnQKCmRlZmluZSAiTG9va2JhY2sgWWVhciI6CiAgSW50ZXJ2YWxbVG9kYXkoKSAtIDEyIG1vbnRocyAtIDEgZGF5cywgVG9kYXkoKSAtIDEgZGF5XQoKZGVmaW5lICJQYXRpZW50IElzIEJlaW5nIFByZXNjcmliZWQgT3Bpb2lkIEFuYWxnZXNpYyB3aXRoIEFtYnVsYXRvcnkgTWlzdXNlIFBvdGVudGlhbCI6CiAgZXhpc3RzICgKICAgIENvbW1vbi4iQWN0aXZlIEFtYnVsYXRvcnkgT3Bpb2lkIFJ4IiBBbWJ1bGF0b3J5T3Bpb2lkUHJlc2NyaXB0aW9uCiAgICAgIHdoZXJlIFJvdXRpbmVzLiJJcyBDaHJvbmljIFBhaW4gUHJlc2NyaXB0aW9uPyIoQW1idWxhdG9yeU9waW9pZFByZXNjcmlwdGlvbikKICApCgpkZWZpbmUgIklzIFJlY29tbWVuZGF0aW9uIEFwcGxpY2FibGU/IjoKICAiSW5jbHVzaW9uIENyaXRlcmlhIgogICAgYW5kIG5vdCAiRXhjbHVzaW9uIENyaXRlcmlhIgoKZGVmaW5lICJQYXRpZW50IEFnZSBMZXNzIFRoYW4gMTgiOgogIGlmIChDb25maWcuIkFnZSBMZXNzIHRoYW4gMTggWWVhcnMgSXMgRW5hYmxlZCIpIHRoZW4KICAgIEFnZUluWWVhcnNBdChUb2RheSgpKSA8IDE4CiAgZWxzZQogICAgZmFsc2UKCmRlZmluZSAiSW5jbHVzaW9uIENyaXRlcmlhIjoKICAiUGF0aWVudCBJcyBCZWluZyBQcmVzY3JpYmVkIE9waW9pZCBBbmFsZ2VzaWMgd2l0aCBBbWJ1bGF0b3J5IE1pc3VzZSBQb3RlbnRpYWwiCiAgICBhbmQgbm90ICJQYXRpZW50IEFnZSBMZXNzIFRoYW4gMTgiCiAgICBhbmQgUm91dGluZXMuIklzIE9waW9pZCBSZXZpZXcgVXNlZnVsPyIKICAgIGFuZCBub3QgIlBhdGllbnQgaGFkIFVyaW5lIFNjcmVlbmluZyBpbiBMYXN0IDEyIE1vbnRocyIKCmRlZmluZSAiRXhjbHVzaW9uIENyaXRlcmlhIjoKICBmYWxzZQoKZGVmaW5lICJQYXRpZW50IGhhZCBVcmluZSBTY3JlZW5pbmcgaW4gTGFzdCAxMiBNb250aHMiOgogIGV4aXN0cyggIlVyaW5lIFNjcmVlbmluZ3MgZHVyaW5nIHRoZSBMYXN0IDEyIE1vbnRocyIgKQoKZGVmaW5lICJVcmluZSBTY3JlZW5pbmdzIGR1cmluZyB0aGUgTGFzdCAxMiBNb250aHMiOgogICJOb24tb3Bpb2lkIFNjcmVlbmluZ3MiCiAgICB1bmlvbiAiT3Bpb2lkIFNjcmVlbmluZ3MiCiAgICB1bmlvbiAiQ29jYWluZSBTY3JlZW5pbmdzIgogICAgdW5pb24gIlBDUCBTY3JlZW5pbmdzIgoKLyoKZXZlcnkgcG9zIGRhdGUgaW4gbGFzdCAxMiBtb250aHMgdGhlbiBjb3VudCAjIG5lZyBhbmQgcmVwb3J0IHRoYXQKbW9zdCByZWNlbnQgUE9TIFBDUC9jb2NhaW5lCiB0aGVuIGdldCBzdWJzZXF1ZW50IG5lZyBkYXRlID4gcG9zIGJhc2VkIG9uIGRhdGUgb2YgZWFjaCBuZWcgYW5kIHBvcwoqLwoKZGVmaW5lICJOb24tb3Bpb2lkIFNjcmVlbmluZ3MiOgogIEdldFJlbGV2YW50U2NyZWVuaW5ncygKICAgIFtPYnNlcnZhdGlvbjogImNhdGVnb3J5IiBpbiBDb21tb24uIk9ic2VydmF0aW9uIENhdGVnb3J5IExhYm9yYXRvcnkiXSBMYWJPYnNlcnZhdGlvbnMKICAgICAgd2hlcmUgKExhYk9ic2VydmF0aW9ucy5jb2RlIGluIENvbW1vbi4iTm9uLW9waW9pZCBkcnVnIHVyaW5lIHNjcmVlbmluZyIpCiAgKQoKZGVmaW5lICJPcGlvaWQgU2NyZWVuaW5ncyI6CiAgR2V0UmVsZXZhbnRTY3JlZW5pbmdzKAogICAgW09ic2VydmF0aW9uOiAiY2F0ZWdvcnkiIGluIENvbW1vbi4iT2JzZXJ2YXRpb24gQ2F0ZWdvcnkgTGFib3JhdG9yeSJdIExhYk9ic2VydmF0aW9ucwogICAgICB3aGVyZSAoTGFiT2JzZXJ2YXRpb25zLmNvZGUgaW4gQ29tbW9uLiJPcGlvaWQgZHJ1ZyB1cmluZSBzY3JlZW5pbmciKQogICkKCmRlZmluZSAiQ29jYWluZSBTY3JlZW5pbmdzIjoKICBHZXRSZWxldmFudFNjcmVlbmluZ3MoCiAgICBbT2JzZXJ2YXRpb246ICJjYXRlZ29yeSIgaW4gQ29tbW9uLiJPYnNlcnZhdGlvbiBDYXRlZ29yeSBMYWJvcmF0b3J5Il0gTGFiT2JzZXJ2YXRpb25zCiAgICAgIHdoZXJlIChMYWJPYnNlcnZhdGlvbnMuY29kZSBpbiAiQ29jYWluZSBVcmluZSBUZXN0cyIpCiAgKQoKZGVmaW5lICJQQ1AgU2NyZWVuaW5ncyI6CiAgR2V0UmVsZXZhbnRTY3JlZW5pbmdzKAogICAgW09ic2VydmF0aW9uOiAiY2F0ZWdvcnkiIGluIENvbW1vbi4iT2JzZXJ2YXRpb24gQ2F0ZWdvcnkgTGFib3JhdG9yeSJdIExhYk9ic2VydmF0aW9ucwogICAgICB3aGVyZSAoTGFiT2JzZXJ2YXRpb25zLmNvZGUgaW4gIlBDUCBVcmluZSBUZXN0cyIpCiAgKQoKCmRlZmluZSBmdW5jdGlvbiBHZXRSZWxldmFudFNjcmVlbmluZ3Mob2JzTGlzdCBMaXN0PE9ic2VydmF0aW9uPik6CiAgb2JzTGlzdCBMYWJPYnNlcnZhdGlvbnMKICAgICB3aGVyZSBkYXRlIGZyb20gTGFiT2JzZXJ2YXRpb25zLmVmZmVjdGl2ZSBpbiBkYXkgb2YgIkxvb2tiYWNrIFllYXIiCiAgICAgICBhbmQgbm90IChMYWJPYnNlcnZhdGlvbnMuc3RhdHVzLnZhbHVlIGluIHsgJ3Vua25vd24nLCAnZW50ZXJlZC1pbi1lcnJvcicsICdjYW5jZWxsZWQnIH0pCgovLyBSZXR1cm5zIGEgdGV4dCByZXByZXNlbnRhdGlvbiBvZiBhIGRhdGVUaW1lIHVzaW5nIHRoZSBDUUwgYFRvU3RyaW5nYCBmdW5jdGlvbi4KLy8gQHBhcmFtIGQgLSBhIEZISVIgZGF0ZVRpbWUgdG8gZ2V0IHRleHQgZm9yCi8vIEByZXR1cm5zIHtTeXN0ZW0uU3RyaW5nfSB0aGUgdGV4dCByZXByZXNlbnRhdGlvbiBvZiB0aGUgZGF0ZVRpbWUKZGVmaW5lIGZ1bmN0aW9uIERhdGVUaW1lVGV4dChkIEZISVIuZGF0ZVRpbWUpOgogIFRvU3RyaW5nKGQudmFsdWUpCgpkZWZpbmUgIlBvc2l0aXZlIFBDUCBTY3JlZW5pbmdzIjoKICAiUENQIFNjcmVlbmluZ3MiIFBDUCB3aGVyZQogICAgU3RhcnRzV2l0aChMb3dlcihQQ1AudmFsdWUgYXMgRkhJUi5zdHJpbmcpLCAncG9zJykKCmRlZmluZSAiTmVnYXRpdmUgUENQIFNjcmVlbmluZ3MiOgogICJQQ1AgU2NyZWVuaW5ncyIgUENQIHdoZXJlCiAgICBTdGFydHNXaXRoKExvd2VyKFBDUC52YWx1ZSBhcyBGSElSLnN0cmluZyksICduZWcnKQoKZGVmaW5lICJQb3NpdGl2ZSBDb2NhaW5lIFNjcmVlbmluZ3MiOgogICJDb2NhaW5lIFNjcmVlbmluZ3MiIENvY2FpbmUgd2hlcmUKICAgIFN0YXJ0c1dpdGgoTG93ZXIoQ29jYWluZS52YWx1ZSBhcyBGSElSLnN0cmluZyksICdwb3MnKQoKZGVmaW5lICJOZWdhdGl2ZSBDb2NhaW5lIFNjcmVlbmluZ3MiOgogICJDb2NhaW5lIFNjcmVlbmluZ3MiIENvY2FpbmUgd2hlcmUKICAgIFN0YXJ0c1dpdGgoTG93ZXIoQ29jYWluZS52YWx1ZSBhcyBGSElSLnN0cmluZyksICduZWcnKQoKLyoKICBib3Jyb3dlZCBmcm9tIENEUzRDUE0gQ0RTX0Nvbm5lY3RfQ29tbW9uc19mb3JfRkhJUnY0MDAKICBTaG91ZGwgdGhpcyBnbyBpbnRvIE9waW9pZENEU0NvbW1vbj8KKi8KZGVmaW5lIGZ1bmN0aW9uIE1vc3RSZWNlbnQoT2JzTGlzdCBMaXN0PE9ic2VydmF0aW9uPik6CiAgTGFzdChPYnNMaXN0IE8gc29ydCBieSBDb2FsZXNjZSgKICAgIChlZmZlY3RpdmUgYXMgRkhJUi5kYXRlVGltZSkudmFsdWUsCiAgICAoZWZmZWN0aXZlIGFzIEZISVIuUGVyaW9kKS4iZW5kIi52YWx1ZSwKICAgIChlZmZlY3RpdmUgYXMgRkhJUi5QZXJpb2QpLiJzdGFydCIudmFsdWUsCiAgICBpc3N1ZWQudmFsdWUpCiAgKQoKZGVmaW5lICJOZWdhdGl2ZSBQQ1AgU2NyZWVuaW5ncyBDb3VudCBTaW5jZSBMYXN0IFBvc2l0aXZlIFNjcmVlbmluZyI6CiAgQ291bnQoCiAgICAiTmVnYXRpdmUgUENQIFNjcmVlbmluZ3MiIE4gd2hlcmUKICAgICAgRGF0ZVRpbWVUZXh0KE4uZWZmZWN0aXZlKSA+ICBEYXRlVGltZVRleHQoIk1vc3RSZWNlbnQiKCJQb3NpdGl2ZSBQQ1AgU2NyZWVuaW5ncyIpLmVmZmVjdGl2ZSkKICApCgpkZWZpbmUgIk5lZ2F0aXZlIENvY2FpbmUgU2NyZWVuaW5ncyBDb3VudCBTaW5jZSBMYXN0IFBvc2l0aXZlIFNjcmVlbmluZyI6CiAgQ291bnQoCiAgICAiTmVnYXRpdmUgQ29jYWluZSBTY3JlZW5pbmdzIiBOIHdoZXJlCiAgICAgIERhdGVUaW1lVGV4dChOLmVmZmVjdGl2ZSkgPiAgRGF0ZVRpbWVUZXh0KCJNb3N0UmVjZW50IigiUG9zaXRpdmUgQ29jYWluZSBTY3JlZW5pbmdzIikuZWZmZWN0aXZlKQogICkKCmRlZmluZSAiUG9zaXRpdmUgQ29jYWluZSBEYXRlcyBpbiBMb29rYmFjayBQZXJpb2QiOgogICJQb3NpdGl2ZSBDb2NhaW5lIFNjcmVlbmluZ3MiIENTCiAgICByZXR1cm4gRGF0ZVRpbWVUZXh0KENTLmVmZmVjdGl2ZSkKCmRlZmluZSAiUG9zaXRpdmUgUENQIERhdGVzIGluIExvb2tiYWNrIFBlcmlvZCI6CiAgIlBvc2l0aXZlIFBDUCBTY3JlZW5pbmdzIiBQUwogICAgcmV0dXJuIERhdGVUaW1lVGV4dChQUy5lZmZlY3RpdmUpCgpkZWZpbmUgIkhhcyBQb3NpdGl2ZSBTY3JlZW5pbmcgZm9yIENvY2FpbmUgaW4gTGFzdCAxMiBNb250aHMiOgogIGV4aXN0cyAiQ29jYWluZSBTY3JlZW5pbmdzIiBDUyB3aGVyZQogICAgIFN0YXJ0c1dpdGgoTG93ZXIoQ1MudmFsdWUgYXMgRkhJUi5zdHJpbmcpLCAncG9zJykKCmRlZmluZSAiSGFzIFBvc2l0aXZlIFNjcmVlbmluZyBmb3IgUENQIGluIExhc3QgMTIgTW9udGhzIjoKICBleGlzdHMgIlBDUCBTY3JlZW5pbmdzIiBQQ1Agd2hlcmUKICAgICBTdGFydHNXaXRoKExvd2VyKFBDUC52YWx1ZSBhcyBGSElSLnN0cmluZyksICdwb3MnKQoKZGVmaW5lICJBcHBsaWNhYmxlIEJlY2F1c2Ugb2YgUG9zaXRpdmUgQ29jYWluZSBvciBQQ1AiOgogICJJcyBSZWNvbW1lbmRhdGlvbiBBcHBsaWNhYmxlPyIKICAgIGFuZCAoIkhhcyBQb3NpdGl2ZSBTY3JlZW5pbmcgZm9yIENvY2FpbmUgaW4gTGFzdCAxMiBNb250aHMiIG9yICJIYXMgUG9zaXRpdmUgU2NyZWVuaW5nIGZvciBQQ1AgaW4gTGFzdCAxMiBNb250aHMiKQoKZGVmaW5lICJBcHBsaWNhYmxlIE5vdCBCZWNhdXNlIG9mIFBvc2l0aXZlIENvY2FpbmUgb3IgUENQIjoKICAiSXMgUmVjb21tZW5kYXRpb24gQXBwbGljYWJsZT8iCiAgICBhbmQgbm90ICJIYXMgUG9zaXRpdmUgU2NyZWVuaW5nIGZvciBDb2NhaW5lIGluIExhc3QgMTIgTW9udGhzIgogICAgYW5kIG5vdCAiSGFzIFBvc2l0aXZlIFNjcmVlbmluZyBmb3IgUENQIGluIExhc3QgMTIgTW9udGhzIgoKZGVmaW5lICJObyBTY3JlZW5pbmcgSW4gTGFzdCAxMiBNb250aHMgRGV0YWlsIjoKICBpZiAiQXBwbGljYWJsZSBOb3QgQmVjYXVzZSBvZiBQb3NpdGl2ZSBDb2NhaW5lIG9yIFBDUCIKICAgIHRoZW4gJ1BhdGllbnRzIG9uIG9waW9pZCB0aGVyYXB5IHNob3VsZCBoYXZlIGEgdXJpbmUgZHJ1ZyB0ZXN0IHBlcmZvcm1lZCBldmVyeSAxMiBtb250aHMuJwogIGVsc2UKICAgIG51bGwKCmRlZmluZSAiTm8gU2NyZWVuaW5nIEluIExhc3QgMTIgTW9udGhzIFN1bW1hcnkiOgogIGlmICJBcHBsaWNhYmxlIE5vdCBCZWNhdXNlIG9mIFBvc2l0aXZlIENvY2FpbmUgb3IgUENQIgogICAgdGhlbiAnQW5udWFsIFVyaW5lIFNjcmVlbmluZyBDaGVjaycKICBlbHNlCiAgICBudWxsCgpkZWZpbmUgIk5vIFNjcmVlbmluZyBJbiBMYXN0IDEyIE1vbnRocyBJbmRpY2F0b3IiOgogIGlmICJJcyBSZWNvbW1lbmRhdGlvbiBBcHBsaWNhYmxlPyIKICAgIHRoZW4gJ3dhcm5pbmcnCiAgZWxzZSBudWxsCgpkZWZpbmUgIlBvc2l0aXZlIENvY2FpbmUgb3IgUENQIEluIExhc3QgMTIgTW9udGhzIERldGFpbCI6CiAgaWYgKCJIYXMgUG9zaXRpdmUgU2NyZWVuaW5nIGZvciBDb2NhaW5lIGluIExhc3QgMTIgTW9udGhzIiBhbmQgIkhhcyBQb3NpdGl2ZSBTY3JlZW5pbmcgZm9yIFBDUCBpbiBMYXN0IDEyIE1vbnRocyIpCiAgICB0aGVuICJDb2NhaW5lIEFuZCBQQ1AgU3VtbWFyeSIKICBlbHNlIGlmICJIYXMgUG9zaXRpdmUgU2NyZWVuaW5nIGZvciBDb2NhaW5lIGluIExhc3QgMTIgTW9udGhzIgogICAgdGhlbiAiQ29jYWluZSBTdW1tYXJ5IgogIGVsc2UgaWYgIkhhcyBQb3NpdGl2ZSBTY3JlZW5pbmcgZm9yIFBDUCBpbiBMYXN0IDEyIE1vbnRocyIKICAgIHRoZW4gIlBDUCBTdW1tYXJ5IgogIGVsc2UKICAgICdEbyBOb3RoaW5nJwoKZGVmaW5lICJQb3NpdGl2ZSBDb2NhaW5lIG9yIFBDUCBJbiBMYXN0IDEyIE1vbnRocyBTdW1tYXJ5IjoKICBpZiAiQXBwbGljYWJsZSBCZWNhdXNlIG9mIFBvc2l0aXZlIENvY2FpbmUgb3IgUENQIgogICAgdGhlbiAnUG9zaXRpdmUgQ29jYWluZSBvciBQQ1AgaW4gVXJpbmUgU2NyZWVuaW5nJwogIGVsc2UKICAgIG51bGwKCmRlZmluZSAiUG9zaXRpdmUgQ29jYWluZSBvciBQQ1AgSW4gTGFzdCAxMiBNb250aHMgSW5kaWNhdG9yIjoKICBpZiAiQXBwbGljYWJsZSBCZWNhdXNlIG9mIFBvc2l0aXZlIENvY2FpbmUgb3IgUENQIgogICAgdGhlbiAnd2FybmluZycKICBlbHNlICdpbmZvJwoKLy8gU2VydmljZSBSZXF1ZXN0IC0gVXJpbmUgU2NyZWVuaW5nCi8vIE5PVEU6IERpc2FibGVkIGR1ZSB0byBGSElSLkFsbFR5cGVzIG5vdCBzdXBwb3J0aW5nIFByb2NlZHVyZVJlcXVlc3QKLyogZGVmaW5lICJVcmluZSBEcnVnIFNjcmVlbmluZyBSZXF1ZXN0IjoKICBQcm9jZWR1cmVSZXF1ZXN0IHsKICAgIC8vaWRlbnRpZmllcjosCiAgICBkZWZpbml0aW9uOiB7IEZISVIuUmVmZXJlbmNlIHsgcmVmZXJlbmNlOiBGSElSLnN0cmluZyB7IHZhbHVlOiAnaHR0cDovL2ZoaXIub3JnL2d1aWRlcy9jZGMvYWN0aXZpdHlkZWZpbml0aW9uL3VyaW5lLXNjcmVlbmluZy1yZXF1ZXN0JyB9IH0gfSwKICAgIHN0YXR1czogRkhJUi5SZXF1ZXN0U3RhdHVzIHsgdmFsdWU6ICdkcmFmdCcgfSwKICAgIGludGVudDogRkhJUi5SZXF1ZXN0SW50ZW50IHsgdmFsdWU6ICdwcm9wb3NhbCcgfSwKICAgIHByaW9yaXR5OiBGSElSLlJlcXVlc3RQcmlvcml0eSB7IHZhbHVlOiAncm91dGluZScgfSwKICAgIGNvZGU6IEZISVIuQ29kZWFibGVDb25jZXB0IHsgY29kaW5nOiB7IFRvQ29kaW5nKCJVcmluZSBEcnVnIFNjcmVlbmluZyIpIH0gfSwKICAgIHN1YmplY3Q6IEZISVIuUmVmZXJlbmNlIHsgcmVmZXJlbmNlOiBGSElSLnN0cmluZyB7IHZhbHVlOiAnUGF0aWVudC8nICsgUGF0aWVudC5pZCB9IH0sCiAgICBvY2N1cnJlbmNlOiBGSElSLlBlcmlvZCB7IHN0YXJ0OiBGSElSLmRhdGVUaW1lIHsgdmFsdWU6IFRvZGF5KCkgfSwgZW5kOiBGSElSLmRhdGVUaW1lIHsgdmFsdWU6IFRvZGF5KCkgKyA3IGRheXMgfSB9LAogICAgYXV0aG9yZWRPbjogRkhJUi5kYXRlVGltZSB7IHZhbHVlOiBOb3coKSB9LAogICAgcmVhc29uQ29kZTogeyBGSElSLkNvZGVhYmxlQ29uY2VwdCB7IHRleHQ6IEZISVIuc3RyaW5nIHsgdmFsdWU6ICJObyBTY3JlZW5pbmcgSW4gTGFzdCAxMiBNb250aHMgRGV0YWlsIiB9IH0gfQogICAgLy8gZG9lc24ndCByZWFsbHkgd29yaywgbmVlZCBhIHJlbGF0ZWRBcnRpZmFjdCBoZXJlLi4uCiAgICAvL3JlYXNvbkNvZGU6IHsgRkhJUi5Db2RlYWJsZUNvbmNlcHQgeyB0ZXh0OiBGSElSLnN0cmluZyB7IHZhbHVlOiAnaHR0cHM6Ly93d3cuY2RjLmdvdi9tbXdyL3ZvbHVtZXMvNjUvcnIvcnI2NTAxZTEuaHRtIzEwX1doZW5fcHJlc2NyaWJpbmdfb3Bpb2lkcycgfSB9IH0KICB9ICovCgpkZWZpbmUgZnVuY3Rpb24gVG9Db2RpbmcoY29kZSBTeXN0ZW0uQ29kZSk6CiAgRkhJUi5Db2RpbmcgewogICAgY29kZTogRkhJUi5jb2RlIHsgdmFsdWU6IGNvZGUuY29kZSB9LAogICAgc3lzdGVtOiBGSElSLnVyaSB7IHZhbHVlOiBjb2RlLnN5c3RlbSB9LAogICAgdmVyc2lvbjogRkhJUi5zdHJpbmcgeyB2YWx1ZTogY29kZS52ZXJzaW9uIH0sCiAgICBkaXNwbGF5OiBGSElSLnN0cmluZyB7IHZhbHVlOiBjb2RlLmRpc3BsYXkgfQogIH0KCmRlZmluZSAiQ29jYWluZSBBbmQgUENQIFN1bW1hcnkiOgogICdQb3NpdGl2ZSBmb3IgQ29jYWluZSBBTkQgUENQIDxici8+PGJyLz4nICsKICAgICJDb2NhaW5lIFN1bW1hcnkiICsgJzxici8+JyArICJQQ1AgU3VtbWFyeSIKCmRlZmluZSAiUENQIFN1bW1hcnkiOgogICdQb3NpdGl2ZSBmb3IgUENQOiA8YnIvPicgKwogICdQb3NpdGl2ZSBsYWIgZGF0ZXM6IDxici8+JyArIENvbWJpbmUoIlBvc2l0aXZlIFBDUCBEYXRlcyBpbiBMb29rYmFjayBQZXJpb2QiLCAnLCA8YnIvPicpICsgJzxici8+JyArCiAgJ05lZ2F0aXZlIHRlc3QgY291bnQgc2luY2UgbGFzdCBQb3NpdGl2ZTogJyArIFRvU3RyaW5nKCJOZWdhdGl2ZSBQQ1AgU2NyZWVuaW5ncyBDb3VudCBTaW5jZSBMYXN0IFBvc2l0aXZlIFNjcmVlbmluZyIpCgpkZWZpbmUgIkNvY2FpbmUgU3VtbWFyeSI6CiAgJ1Bvc2l0aXZlIGZvciBDb2NhaW5lOiA8YnIvPicgKwogICdQb3NpdGl2ZSBsYWIgZGF0ZXM6IDxici8+JyArIENvbWJpbmUoIlBvc2l0aXZlIENvY2FpbmUgRGF0ZXMgaW4gTG9va2JhY2sgUGVyaW9kIiwgJzxici8+JykgKyAnPGJyLz4nICsKICAnTmVnYXRpdmUgdGVzdCBjb3VudCBzaW5jZSBsYXN0IFBvc2l0aXZlOiAnICsgVG9TdHJpbmcoIk5lZ2F0aXZlIENvY2FpbmUgU2NyZWVuaW5ncyBDb3VudCBTaW5jZSBMYXN0IFBvc2l0aXZlIFNjcmVlbmluZyIpCg=="
  } ]
}